<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams + AI Room</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #667eea;
            color: white;
        }

        .sidebar-header h2 { font-size: 18px; margin-bottom: 5px; }
        .user-info { font-size: 14px; opacity: 0.9; }

        .participants {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .participants h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .participant {
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 14px;
        }

        .participant.riley {
            background: #e3f2fd;
            border-left: 3px solid #667eea;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 { font-size: 20px; color: #333; }

        .spawn-riley-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .spawn-riley-btn:hover { background: #5568d3; }
        .spawn-riley-btn:disabled { background: #ccc; cursor: not-allowed; }

        .video-grid {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-gap: 15px;
            overflow-y: auto;
        }

        .video-container {
            background: #000;
            border-radius: 8px;
            aspect-ratio: 16/9;
            position: relative;
            overflow: hidden;
        }

        .video-container video,
        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .chat-panel {
            height: 250px;
            border-top: 1px solid #ddd;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .chat-message .sender {
            font-weight: 600;
            color: #667eea;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .chat-input-area button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .chat-input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .thinking-indicator {
            font-style: italic;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Teams + AI</h2>
            <div class="user-info" id="user-info">Loading...</div>
        </div>
        <div class="participants">
            <h3>Participants</h3>
            <div id="participants-list"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1>Room: default</h1>
            <div style="display: flex; gap: 10px;">
                <button id="save-chat-btn" class="spawn-riley-btn" onclick="saveChat()" style="background: #28a745;">
                    Save Chat
                </button>
                <button id="spawn-riley-btn" class="spawn-riley-btn" onclick="spawnRiley()">
                    Spawn RILEY
                </button>
            </div>
        </div>

        <div class="video-grid" id="video-grid"></div>

        <div class="chat-panel">
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message..." />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Get user info from sessionStorage
        const userId = sessionStorage.getItem('user_id');
        const userName = sessionStorage.getItem('user_name');
        const userRole = sessionStorage.getItem('user_role');

        // Redirect to login if not logged in
        if (!userId || !userName) {
            window.location.href = '/login';
        }

        // Display user info
        document.getElementById('user-info').textContent = `${userName} (${userRole})`;

        // Socket.IO connection
        const socket = io();
        const room = 'default';
        let participants = {};
        let rileySpawned = false;

        // Connect to server
        socket.on('connect', function() {
            console.log('Connected to server');

            // Join room with proper user info
            socket.emit('join_room', {
                room: room,
                user_id: userId,
                user_name: userName,
                type: 'human'
            });
        });

        // Participant joined
        socket.on('participant_joined', function(data) {
            console.log('Participant joined:', data);

            participants[data.user_id] = {
                name: data.user_name || data.user_id,
                type: data.type || 'human',
                video_url: data.video_url
            };

            updateParticipantsList();
        });

        // RILEY joined
        socket.on('ai_bot_joined', function(data) {
            console.log('RILEY joined:', data);

            if (data.status === 'created' || data.status === 'already_exists') {
                const rileyName = `RILEY (${userName})`;
                participants[data.bot_id] = {
                    name: rileyName,
                    type: 'riley'
                };
                rileySpawned = true;
                document.getElementById('spawn-riley-btn').disabled = true;
                updateParticipantsList();
                addChatMessage('System', `${rileyName} has joined`);
            }
        });

        // AI message received
        socket.on('ai_message', function(data) {
            console.log('AI message:', data);

            // Remove any thinking indicators
            document.querySelectorAll('.thinking-indicator').forEach(el => el.remove());

            // Re-enable send button
            const sendBtn = document.querySelector('.chat-input-area button');
            const input = document.getElementById('chat-input');
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
            if (input) {
                input.disabled = false;
            }

            // Show AI message
            const senderName = data.bot_id.includes('_') ? 'RILEY' : data.bot_id;
            addChatMessage(senderName, data.text);
        });

        // Update participants list
        function updateParticipantsList() {
            const list = document.getElementById('participants-list');
            list.innerHTML = '';

            Object.keys(participants).forEach(id => {
                const p = participants[id];
                const div = document.createElement('div');
                div.className = `participant ${p.type === 'riley' ? 'riley' : ''}`;
                div.textContent = p.name;
                list.appendChild(div);
            });
        }

        // Spawn RILEY
        function spawnRiley() {
            if (rileySpawned) {
                alert('RILEY already spawned');
                return;
            }

            socket.emit('spawn_ai_bot', {
                room: room,
                user_id: userId,
                user_name: userName
            });
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const sendBtn = document.querySelector('.chat-input-area button');
            const text = input.value.trim();

            if (!text) return;

            // Show user message immediately
            addChatMessage(userName, text);

            // Disable send button and show loading
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.textContent = 'â³';
            }
            input.disabled = true;

            // Show "thinking" indicator
            const thinkingId = addThinkingMessage('RILEY');

            socket.emit('user_message', {
                room: room,
                user_id: userId,
                text: text
            });

            input.value = '';

            // Re-enable after timeout (safety fallback)
            setTimeout(() => {
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send';
                }
                input.disabled = false;
                removeThinkingMessage(thinkingId);
            }, 60000); // 60 second timeout
        }

        // Add chat message
        function addChatMessage(sender, text) {
            const messages = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-message';
            div.innerHTML = `<span class="sender">${sender}:</span> ${text}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // Add thinking indicator
        function addThinkingMessage(sender) {
            const messages = document.getElementById('chat-messages');
            const thinkingId = `thinking-${Date.now()}`;
            const div = document.createElement('div');
            div.id = thinkingId;
            div.className = 'chat-message thinking-indicator';
            div.innerHTML = `<span class="sender">${sender}:</span> <em>Thinking...</em>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
            return thinkingId;
        }

        // Remove thinking indicator
        function removeThinkingMessage(thinkingId) {
            const element = document.getElementById(thinkingId);
            if (element) {
                element.remove();
            }
        }

        // Enter key to send message
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Save chat history
        function saveChat() {
            const format = 'md'; // or 'json'
            const url = `/api/export_history?format=${format}&room=${room}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Export failed');
                    return response.blob();
                })
                .then(blob => {
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `conversation_history_${room}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    addChatMessage('System', 'Chat history saved');
                })
                .catch(error => {
                    console.error('Save error:', error);
                    alert('Failed to save chat history');
                });
        }

        // Add current user to participants
        participants[userId] = {
            name: userName,
            type: 'human'
        };
        updateParticipantsList();
    </script>
</body>
</html>
