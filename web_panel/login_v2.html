<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-HRI Login v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #1a1a1a;
            --bg-medium: #2a2a2a;
            --bg-light: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #444;
            --accent-color: #4a9eff;
            --success-color: #4caf50;
            --warning-color: #ff9800;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login Container */
        .login-container {
            background: var(--bg-medium);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 480px;
            max-width: 95vw;
            overflow: hidden;
        }

        /* Header */
        .login-header {
            background: var(--bg-dark);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .login-header h1 {
            font-size: 16px;
            font-weight: normal;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .login-header .version {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: center;
            padding: 16px;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border-color);
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-color);
            margin: 0 8px;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--accent-color);
        }

        .step-dot.completed {
            background: var(--success-color);
        }

        /* Step Content */
        .step-content {
            padding: 24px;
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .step-title {
            font-size: 14px;
            font-weight: normal;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .step-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* Form Elements */
        label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            margin-bottom: 16px;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Info Display */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
        }

        /* Project List */
        .project-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .project-card {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-card:hover {
            border-color: var(--accent-color);
        }

        .project-card.selected {
            border-color: var(--accent-color);
            background: rgba(74, 158, 255, 0.1);
        }

        .project-name {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .project-details {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .project-status {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .badge-real { background: var(--success-color); color: #000; }
        .badge-fake { background: var(--warning-color); color: #000; }
        .badge-active { background: var(--success-color); color: #000; }
        .badge-inactive { background: var(--border-color); color: var(--text-secondary); }

        /* Section Divider */
        .section-divider {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Checkbox & Radio */
        .checkbox-group, .radio-group {
            margin-bottom: 16px;
        }

        .checkbox-group label, .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-primary);
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0;
        }

        .radio-option {
            margin-bottom: 8px;
        }

        input[type="checkbox"], input[type="radio"] {
            width: auto;
            margin: 0;
        }

        /* Robot Entry */
        .robot-entries {
            margin-bottom: 16px;
        }

        .robot-entry {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .robot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .robot-header span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .robot-entry select {
            margin-bottom: 8px;
        }

        .mode-options {
            display: flex;
            gap: 16px;
        }

        .mode-options label {
            display: flex;
            align-items: center;
            gap: 4px;
            text-transform: none;
            letter-spacing: 0;
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-light);
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #4a4a4a;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: #000;
        }

        .btn-primary:hover {
            background: #3a8eef;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn-danger {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }

        /* Button Groups */
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn-group-split {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn-group-center {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        /* Connection Status */
        .connection-status {
            margin: 16px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-icon {
            font-size: 16px;
        }

        .status-text {
            font-size: 12px;
        }

        .status-detail {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 26px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- Header -->
        <div class="login-header">
            <h1>MULTI-HRI LOGIN</h1>
            <span class="version">Project-Based System v2.0</span>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step-dot active" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
            <div class="step-dot" data-step="4"></div>
        </div>

        <!-- Step 1: User Selection -->
        <div class="step-content active" id="step-1">
            <h2 class="step-title">USER SELECTION</h2>
            <p class="step-description">Select your user profile to continue</p>

            <label for="user-select">User</label>
            <select id="user-select">
                <option value="">Select user...</option>
            </select>

            <div id="user-info" style="display: none;">
                <div class="info-row">
                    <span class="info-label">Role</span>
                    <span class="info-value" id="user-role">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Default Server</span>
                    <span class="info-value" id="user-server">-</span>
                </div>
            </div>

            <div class="btn-group-split">
                <div></div>
                <button class="btn btn-primary" id="step1-next" disabled>Next</button>
            </div>
        </div>

        <!-- Step 2: Project Selection -->
        <div class="step-content" id="step-2">
            <h2 class="step-title">PROJECT SELECTION</h2>
            <p class="step-description">Welcome, <span id="welcome-name">-</span></p>

            <div class="project-list" id="project-list">
                <div class="empty-state">No projects found. Create a new project to get started.</div>
            </div>

            <div class="btn-group-center">
                <button class="btn" id="new-project-btn">+ New Project</button>
                <button class="btn" id="join-project-btn">Join Existing</button>
            </div>

            <div class="btn-group-split">
                <button class="btn" id="step2-back">Back</button>
                <button class="btn btn-primary" id="step2-next" disabled>Enter</button>
            </div>
        </div>

        <!-- Step 3: New Project Creation -->
        <div class="step-content" id="step-3">
            <h2 class="step-title">NEW PROJECT</h2>
            <p class="step-description">Configure your project settings</p>

            <label for="project-name">Project Name</label>
            <input type="text" id="project-name" placeholder="My Project">

            <div class="section-divider">Server Settings</div>

            <label for="my-location">My Location</label>
            <select id="my-location">
                <option value="">Select location...</option>
            </select>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="is-server-host" checked>
                    I will host the server
                </label>
            </div>

            <label>External Access</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="access-mode" value="local_only" id="access-local" checked>
                    <label for="access-local">Local Only (same network)</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="access-mode" value="remote_enabled" id="access-remote">
                    <label for="access-remote">Remote Enabled (Foxglove + ngrok)</label>
                </div>
            </div>

            <div id="foxglove-group" style="display: none;">
                <label for="foxglove-endpoint">Foxglove Endpoint</label>
                <input type="text" id="foxglove-endpoint" placeholder="wss://foxglove.multi-hri.ngrok.app">
            </div>

            <div class="section-divider">Robot Settings</div>

            <button class="btn btn-small" id="add-robot-btn">+ Add Robot</button>

            <div class="robot-entries" id="robot-entries">
                <!-- Robot entries added dynamically -->
            </div>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="ar-only-mode">
                    AR Only Mode (no robot connection)
                </label>
            </div>

            <div class="btn-group-split">
                <button class="btn" id="step3-back">Back</button>
                <button class="btn btn-primary" id="step3-create">Create Project</button>
            </div>
        </div>

        <!-- Step 4: Connection -->
        <div class="step-content" id="step-4">
            <h2 class="step-title">CONNECTING</h2>
            <p class="step-description">Project: <span id="connecting-project">-</span></p>

            <div class="connection-status" id="connection-status">
                <div class="status-item" id="status-server">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Connecting to server...</span>
                </div>
                <div class="status-item" id="status-foxglove" style="display: none;">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Connecting to Foxglove...</span>
                </div>
                <div class="status-item" id="status-fusion">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Joining Fusion2 Room...</span>
                </div>
                <div class="status-item" id="status-robot" style="display: none;">
                    <span class="status-icon">⏳</span>
                    <span class="status-text">Initializing robot...</span>
                </div>
            </div>

            <div class="btn-group-center">
                <button class="btn btn-danger" id="step4-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // DATA SOURCES - Replace with actual API calls later
        // ============================================================
        const DATA_SOURCES = {
            // Users - from /api/users (실제 API)
            async getUsers() {
                try {
                    console.log('[API] Fetching /api/users...');
                    const response = await fetch('/api/users');
                    console.log('[API] Response status:', response.status);
                    const data = await response.json();
                    console.log('[API] Data:', data);
                    if (data.status === 'success' && data.users) {
                        // Transform API response to expected format
                        const users = {};
                        Object.entries(data.users).forEach(([userId, user]) => {
                            users[userId] = {
                                user_id: userId,
                                display_name: user.display_name || userId,
                                role: user.role || 'user',
                                ros_server: user.server?.ros_server || 'localhost',
                                permissions: user.permissions || {}
                            };
                        });
                        return users;
                    }
                    return {};
                } catch (error) {
                    console.error('Failed to load users:', error);
                    return {};
                }
            },

            // Locations - from /api/locations (실제 API)
            async getLocations() {
                try {
                    console.log('[API] Fetching /api/locations...');
                    const response = await fetch('/api/locations');
                    const data = await response.json();
                    console.log('[API] Locations:', data);
                    if (data.status === 'success' && data.locations) {
                        // Transform to array format
                        return Object.entries(data.locations).map(([key, info]) => ({
                            key: key,
                            host: info.host,
                            port: info.port
                        }));
                    }
                    return [];
                } catch (error) {
                    console.error('Failed to load locations:', error);
                    return [];
                }
            },

            // Robot Types - from /api/robot-types (실제 API)
            async getRobotTypes() {
                try {
                    console.log('[API] Fetching /api/robot-types...');
                    const response = await fetch('/api/robot-types');
                    const data = await response.json();
                    console.log('[API] Robot types:', data);
                    if (data.status === 'success' && data.robot_types) {
                        return data.robot_types;
                    }
                    return [];
                } catch (error) {
                    console.error('Failed to load robot types:', error);
                    return [];
                }
            },

            // Projects - from /api/projects (실제 API)
            async getProjects(userId) {
                try {
                    console.log('[API] Fetching /api/projects/?user=' + userId);
                    const response = await fetch(`/api/projects/?user=${userId}`);
                    const data = await response.json();
                    console.log('[API] Projects:', data);
                    if (data.status === 'success' && data.projects) {
                        return data.projects;
                    }
                    return [];
                } catch (error) {
                    console.error('Failed to load projects:', error);
                    return [];
                }
            },

            // Save Project - POST /api/projects/ (실제 API)
            async saveProject(project) {
                try {
                    console.log('[API] Creating project:', project);
                    const response = await fetch('/api/projects/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(project)
                    });
                    const data = await response.json();
                    console.log('[API] Create project result:', data);
                    return { success: data.status === 'success', project: data };
                } catch (error) {
                    console.error('Failed to save project:', error);
                    return { success: false, error: error.message };
                }
            }
        };

        // ============================================================
        // STATE
        // ============================================================
        let currentStep = 1;
        let selectedUser = null;
        let selectedProject = null;
        let usersData = {};
        let locationsData = [];
        let robotTypesData = [];
        let robotCount = 0;

        // ============================================================
        // INITIALIZATION
        // ============================================================
        async function init() {
            await loadUsers();
            await loadLocations();
            await loadRobotTypes();
            setupEventListeners();
        }

        async function loadUsers() {
            console.log('[Login v2] Loading users from API...');
            usersData = await DATA_SOURCES.getUsers();
            console.log('[Login v2] Users received:', usersData);

            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">Select user...</option>';

            const userList = Object.values(usersData);
            console.log('[Login v2] User list:', userList.length, 'users');

            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = `${user.display_name} (${user.role})`;
                select.appendChild(option);
                console.log('[Login v2] Added user option:', user.display_name);
            });
        }

        async function loadLocations() {
            locationsData = await DATA_SOURCES.getLocations();
            const select = document.getElementById('my-location');
            select.innerHTML = '<option value="">Select location...</option>';

            locationsData.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.key;
                option.textContent = loc.key;
                select.appendChild(option);
            });
        }

        async function loadRobotTypes() {
            robotTypesData = await DATA_SOURCES.getRobotTypes();
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        function setupEventListeners() {
            // Step 1: User Selection
            document.getElementById('user-select').addEventListener('change', onUserSelect);
            document.getElementById('step1-next').addEventListener('click', () => goToStep(2));

            // Step 2: Project Selection
            document.getElementById('step2-back').addEventListener('click', () => goToStep(1));
            document.getElementById('step2-next').addEventListener('click', () => goToStep(4));
            document.getElementById('new-project-btn').addEventListener('click', () => goToStep(3));
            document.getElementById('join-project-btn').addEventListener('click', onJoinProject);

            // Step 3: New Project
            document.getElementById('step3-back').addEventListener('click', () => goToStep(2));
            document.getElementById('step3-create').addEventListener('click', onCreateProject);
            document.getElementById('add-robot-btn').addEventListener('click', addRobotEntry);
            document.getElementById('ar-only-mode').addEventListener('change', onAROnlyChange);
            document.querySelectorAll('input[name="access-mode"]').forEach(radio => {
                radio.addEventListener('change', onAccessModeChange);
            });

            // Step 4: Connection
            document.getElementById('step4-cancel').addEventListener('click', () => goToStep(2));
        }

        // ============================================================
        // STEP 1: USER SELECTION
        // ============================================================
        async function onUserSelect(e) {
            const userId = e.target.value;
            const nextBtn = document.getElementById('step1-next');
            const userInfo = document.getElementById('user-info');

            if (userId && usersData[userId]) {
                selectedUser = usersData[userId];

                document.getElementById('user-role').textContent = selectedUser.role;
                document.getElementById('user-server').textContent = selectedUser.ros_server;
                userInfo.style.display = 'block';
                nextBtn.disabled = false;
            } else {
                selectedUser = null;
                userInfo.style.display = 'none';
                nextBtn.disabled = true;
            }
        }

        // ============================================================
        // STEP 2: PROJECT SELECTION
        // ============================================================
        async function loadProjects() {
            if (!selectedUser) return;

            document.getElementById('welcome-name').textContent = selectedUser.display_name;

            const projects = await DATA_SOURCES.getProjects(selectedUser.user_id);
            const container = document.getElementById('project-list');

            if (projects.length === 0) {
                container.innerHTML = '<div class="empty-state">No projects found. Create a new project to get started.</div>';
                return;
            }

            container.innerHTML = projects.map(p => `
                <div class="project-card" data-project-id="${p.id}" onclick="selectProject('${p.id}')">
                    <div class="project-name">${p.name}</div>
                    <div class="project-details">
                        Server: ${p.server.ros2_server || 'none'} |
                        Robots: ${p.robots.length}
                    </div>
                    <div class="project-status">
                        ${p.robots.length > 0 ?
                            `<span class="badge badge-${p.robots[0].mode.toLowerCase()}">${p.robots[0].mode}</span>` :
                            '<span class="badge badge-inactive">AR Only</span>'}
                        <span class="badge badge-${p.status}">${p.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectProject(projectId) {
            document.querySelectorAll('.project-card').forEach(card => {
                card.classList.remove('selected');
            });

            const card = document.querySelector(`[data-project-id="${projectId}"]`);
            if (card) {
                card.classList.add('selected');
                selectedProject = { id: projectId };
                document.getElementById('step2-next').disabled = false;
            }
        }

        function onJoinProject() {
            // TODO: Show modal to enter project ID or scan QR
            alert('Join project feature - Coming soon!\nEnter project ID to join.');
        }

        // ============================================================
        // STEP 3: NEW PROJECT
        // ============================================================
        function addRobotEntry() {
            const container = document.getElementById('robot-entries');
            const index = robotCount++;

            const robotTypeOptions = robotTypesData.map(type =>
                `<option value="${type}">${type}</option>`
            ).join('');

            const entry = document.createElement('div');
            entry.className = 'robot-entry';
            entry.id = `robot-entry-${index}`;
            entry.innerHTML = `
                <div class="robot-header">
                    <span>Robot ${index + 1}</span>
                    <button class="btn btn-small btn-danger" onclick="removeRobotEntry(${index})">Remove</button>
                </div>
                <label>Type</label>
                <select class="robot-type" data-index="${index}">
                    <option value="">Select robot...</option>
                    ${robotTypeOptions}
                </select>
                <label>Mode</label>
                <div class="mode-options">
                    <label><input type="radio" name="robot-${index}-mode" value="Real"> Real</label>
                    <label><input type="radio" name="robot-${index}-mode" value="Fake" checked> Fake</label>
                    <label><input type="radio" name="robot-${index}-mode" value="Gazebo"> Gazebo</label>
                </div>
            `;
            container.appendChild(entry);
        }

        function removeRobotEntry(index) {
            const entry = document.getElementById(`robot-entry-${index}`);
            if (entry) entry.remove();
        }

        function onAROnlyChange(e) {
            const robotSection = document.getElementById('robot-entries');
            const addBtn = document.getElementById('add-robot-btn');

            if (e.target.checked) {
                robotSection.style.display = 'none';
                addBtn.style.display = 'none';
            } else {
                robotSection.style.display = 'block';
                addBtn.style.display = 'inline-block';
            }
        }

        function onAccessModeChange(e) {
            const foxgloveGroup = document.getElementById('foxglove-group');
            foxgloveGroup.style.display = e.target.value === 'remote_enabled' ? 'block' : 'none';
        }

        async function onCreateProject() {
            const projectName = document.getElementById('project-name').value.trim();
            const myLocation = document.getElementById('my-location').value;
            const isServerHost = document.getElementById('is-server-host').checked;
            const accessMode = document.querySelector('input[name="access-mode"]:checked').value;
            const foxgloveEndpoint = document.getElementById('foxglove-endpoint').value.trim();
            const arOnly = document.getElementById('ar-only-mode').checked;

            // Validation
            if (!projectName) {
                alert('Please enter a project name');
                return;
            }
            if (!myLocation) {
                alert('Please select your location');
                return;
            }

            // Collect robots
            const robots = [];
            if (!arOnly) {
                const robotEntries = document.querySelectorAll('.robot-entry');
                robotEntries.forEach((entry, i) => {
                    const typeSelect = entry.querySelector('.robot-type');
                    const modeRadio = entry.querySelector(`input[name^="robot-"][name$="-mode"]:checked`);

                    if (typeSelect && typeSelect.value) {
                        robots.push({
                            namespace: `robot${i + 1}`,
                            type: typeSelect.value,
                            mode: modeRadio ? modeRadio.value : 'Fake',
                            owner: selectedUser.user_id
                        });
                    }
                });
            }

            // Build project object
            const projectId = projectName.toLowerCase().replace(/\s+/g, '_');
            const project = {
                id: projectId,
                name: projectName,
                server_host: isServerHost ? selectedUser.user_id : null,
                server: {
                    my_location: myLocation,
                    ros2_server: determineROS2Server(myLocation, robots),
                    access_mode: accessMode,
                    foxglove_endpoint: accessMode === 'remote_enabled' ? foxgloveEndpoint : null
                },
                robots: robots,
                participants: [selectedUser.user_id],
                status: 'inactive'
            };

            // Save
            const result = await DATA_SOURCES.saveProject(project);
            if (result.success) {
                selectedProject = project;
                goToStep(4);
            }
        }

        function determineROS2Server(myLocation, robots) {
            if (robots.length === 0) return null; // AR Only

            const firstRobot = robots[0];
            if (firstRobot.mode === 'Real') {
                // TODO: Get robot's location from robot_qr_mapping.yaml
                // For now, use my_location
                return myLocation;
            }
            // Fake/Gazebo -> use user's location
            return myLocation;
        }

        // ============================================================
        // STEP 4: CONNECTION
        // ============================================================
        async function startConnection() {
            if (!selectedProject) return;

            document.getElementById('connecting-project').textContent = selectedProject.name || selectedProject.id;

            // Show relevant status items
            const server = selectedProject.server || {};

            if (server.foxglove_endpoint) {
                document.getElementById('status-foxglove').style.display = 'flex';
            }
            if (selectedProject.robots && selectedProject.robots.length > 0) {
                document.getElementById('status-robot').style.display = 'flex';
            }

            // Simulate connection sequence
            await simulateConnection('status-server', 'Server connected', server.ros2_server);

            if (server.foxglove_endpoint) {
                await simulateConnection('status-foxglove', 'Foxglove connected', server.foxglove_endpoint);
            }

            await simulateConnection('status-fusion', 'Joined Fusion2 Room', `MultiHRI-${selectedProject.id}`);

            if (selectedProject.robots && selectedProject.robots.length > 0) {
                await simulateConnection('status-robot', 'Robot initialized', selectedProject.robots[0].type);
            }

            // Save session and redirect
            saveSession();
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        async function simulateConnection(elementId, successText, detail) {
            const item = document.getElementById(elementId);
            await new Promise(r => setTimeout(r, 500 + Math.random() * 500));

            item.querySelector('.status-icon').textContent = '✅';
            item.querySelector('.status-text').textContent = successText;

            if (detail) {
                const detailEl = document.createElement('div');
                detailEl.className = 'status-detail';
                detailEl.textContent = `(${detail})`;
                item.appendChild(detailEl);
            }
        }

        function saveSession() {
            // index.html과 호환되는 형식으로 저장 (id, name, role 필드명 사용)
            const userForIndex = {
                id: selectedUser.user_id,
                name: selectedUser.display_name,
                role: selectedUser.role
            };

            sessionStorage.setItem('user_id', selectedUser.user_id);
            sessionStorage.setItem('user_name', selectedUser.display_name);
            sessionStorage.setItem('user_role', selectedUser.role);
            sessionStorage.setItem('currentUser', JSON.stringify(userForIndex));
            sessionStorage.setItem('currentProject', JSON.stringify(selectedProject));
        }

        // ============================================================
        // NAVIGATION
        // ============================================================
        function goToStep(step) {
            // Update dots
            document.querySelectorAll('.step-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i + 1 < step) dot.classList.add('completed');
                if (i + 1 === step) dot.classList.add('active');
            });

            // Update content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step-${step}`).classList.add('active');

            currentStep = step;

            // Step-specific actions
            if (step === 2) {
                loadProjects();
            } else if (step === 4) {
                startConnection();
            }
        }

        // ============================================================
        // START
        // ============================================================
        console.log('[Login v2] Starting initialization...');
        init().then(() => {
            console.log('[Login v2] Init complete. Users loaded:', Object.keys(usersData));
        }).catch(err => {
            console.error('[Login v2] Init error:', err);
        });
    </script>
</body>
</html>
