services:

  # Foxglove Bridge for WebSocket communication with web panel
  foxglove-bridge:
    build:
      context: ../foxglove-bridge
      dockerfile: Dockerfile
    container_name: foxglove-bridge
    network_mode: "host"
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    restart: unless-stopped
    depends_on:
      - multi-hri2-control

  # Main multi-hri2 control service with integrated rosbridge (WSL2 version)
  multi-hri2-control:
    container_name: multi-hri2-control
    image: multi-hri2-control:latest  
    build:
      context: ..
      dockerfile: ./robot-control/multi-hri2-control.Dockerfile
    privileged: true
    network_mode: "host"
    environment:
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - GAZEBO_RESOURCE_PATH=/workspace/src/xarm_ros2
      - DISPLAY=${WSL_HOST_IP:-host.docker.internal:0.0}
      - QT_X11_NO_MITSHM=${QT_X11_NO_MITSHM}
      - HOST_UID=${UID:-1000}
      - HOST_GID=${GID:-1000}
      - PYTHONPATH=/workspace:/workspace/src:/workspace/server:${PYTHONPATH}
      - CONFIG_DIR=/workspace/server/config
    volumes:
      - /dev/shm:/dev/shm
      - ../../ros2/multi_hri_ros2:/workspace/src/multi_hri_ros2
      - ${TEST_RESULTS_DIR:-./results}/multi-hri2:/results
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      - ${XAUTHORITY:-~/.Xauthority}:/root/.Xauthority:ro
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 12G
    command: >
      bash -c "
        rm -f /dev/shm/fastrtps* && 
        mkdir -p /results && 
        chown -R $HOST_UID:$HOST_GID /results && 
        chmod -R 755 /results && 
        source /opt/ros/humble/setup.bash && 
        cd /workspace && 
        # xarm 패키지들은 Docker 이미지에서 이미 빌드되어 있으므로 제외
        colcon build --cmake-args -DAMENT_CMAKE_SYMLINK_INSTALL=OFF --packages-skip xarm_msgs xarm_sdk xarm_description xarm_api xarm_controller xarm_gazebo xarm_moveit_config xarm_moveit_servo xarm_planner &&
        echo 'multi_hri_ros2 packages built successfully!' && 
        source /workspace/install/setup.bash && 
        ros2 topic list && 
        echo 'ROS2 is working!' && 
        echo 'Rosbridge server running on port 9090' && 
        tail -f /dev/null
      "


